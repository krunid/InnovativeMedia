<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ทะเบียนผลิตสื่อและนวัตกรรมการสอน</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #f5f5f5;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .app-header {
      background-color: #0d6efd;
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .app-title {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
    }
    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      font-weight: bold;
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-success {
      background-color: #198754;
      border-color: #198754;
    }
    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
    }
    .btn-warning {
      background-color: #ffc107;
      border-color: #ffc107;
      color: #000;
    }
    .table {
      background-color: white;
    }
    .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    .modal-footer {
      background-color: #f8f9fa;
      border-top: 1px solid #dee2e6;
    }
    .tab-content {
      padding: 20px;
      background-color: white;
      border: 1px solid #dee2e6;
      border-top: none;
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
    }
    
    /* สไตล์สำหรับหน้ารายงาน */
    @media print {
      .no-print {
        display: none !important;
      }
      body {
        padding: 0;
        margin: 0;
      }
      .container {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
      }
      .table th, .table td {
        border: 1px solid #000;
      }
      .page-header {
        text-align: center;
        margin-bottom: 20px;
      }
    }
    
    .report-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .report-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .report-subtitle {
      font-size: 18px;
      margin-bottom: 5px;
    }
    .report-date {
      font-size: 14px;
      margin-bottom: 20px;
    }
    .table-container {
      margin-bottom: 30px;
    }
    .summary-container {
      margin-top: 30px;
      margin-bottom: 30px;
    }
    .filter-container {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1 class="app-title">ทะเบียนผลิตสื่อและนวัตกรรมการสอน</h1>
    </div>
    
    <!-- แท็บเมนู -->
    <ul class="nav nav-tabs" id="appTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
          <i class="bi bi-house-door"></i> หน้าหลัก
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab" aria-controls="report" aria-selected="false">
          <i class="bi bi-file-earmark-text"></i> รายงาน
        </button>
      </li>
    </ul>
    
    <!-- เนื้อหาแท็บ -->
    <div class="tab-content" id="appTabsContent">
      <!-- แท็บหน้าหลัก -->
      <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
        <!-- ส่วนเพิ่มข้อมูล -->
        <div class="card mb-4">
          <div class="card-header">
            <i class="bi bi-plus-circle"></i> เพิ่มข้อมูล
          </div>
          <div class="card-body">
            <form id="addForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">ชื่อสื่อ/นวัตกรรม</label>
                  <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="col-md-6">
                  <label for="producer" class="form-label">ชื่อผู้ผลิตสื่อ/นวัตกรรม</label>
                  <input type="text" class="form-control" id="producer" name="producer" required>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="amount" class="form-label">จำนวน</label>
                  <input type="number" class="form-control" id="amount" name="amount" min="1" required>
                </div>
                <div class="col-md-4">
                  <label for="object" class="form-label">จุดประสงค์</label>
                  <input type="text" class="form-control" id="object" name="object" required>
                </div>
                <div class="col-md-4">
                  <label for="name2" class="form-label">ผู้รับรอง</label>
                  <input type="text" class="form-control" id="name2" name="name2" required>
                </div>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save"></i> บันทึกข้อมูล
                </button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- ส่วนแสดงข้อมูล -->
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <i class="bi bi-table"></i> ข้อมูลทั้งหมด
              </div>
              <button class="btn btn-sm btn-primary" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> รีเฟรช
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ลำดับ</th>
                    <th>วันที่</th>
                    <th>ชื่อสื่อ/นวัตกรรม</th>
                    <th>ชื่อผู้ผลิตสื่อ</th>
                    <th>จำนวน</th>
                    <th>จุดประสงค์</th>
                    <th>ผู้รับรอง</th>
                    <th>จัดการ</th>
                  </tr>
                </thead>
                <tbody id="dataTableBody">
                  <!-- ข้อมูลจะถูกเพิ่มด้วย JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- แท็บรายงาน -->
      <div class="tab-pane fade" id="report" role="tabpanel" aria-labelledby="report-tab">
        <!-- ส่วนตัวกรองรายงาน (ไม่แสดงในการพิมพ์) -->
        <div class="filter-container no-print">
          <h4>ตัวเลือกรายงาน</h4>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="reportType" class="form-label">ประเภทรายงาน</label>
                <select class="form-select" id="reportType">
                  <option value="all">รายงานทั้งหมด</option>
                  <option value="byProducer">รายงานแยกตามผู้ผลิตสื่อ</option>
                  <option value="summary">รายงานสรุปตามผู้ผลิตสื่อ</option>
                </select>
              </div>
            </div>
            <div class="col-md-6" id="producerFilterContainer" style="display: none;">
              <div class="mb-3">
                <label for="producerFilter" class="form-label">เลือกผู้ผลิตสื่อ</label>
                <select class="form-select" id="producerFilter">
                  <option value="">-- เลือกผู้ผลิตสื่อ --</option>
                  <!-- จะเติมข้อมูลด้วย JavaScript -->
                </select>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-between">
            <button class="btn btn-primary" id="generateReportBtn">สร้างรายงาน</button>
            <button class="btn btn-success" id="printReportBtn">พิมพ์รายงาน</button>
          </div>
        </div>

        <!-- ส่วนหัวรายงาน -->
        <div class="report-header">
          <div class="report-title">รายงานทะเบียนผลิตสื่อและนวัตกรรมการสอน</div>
          <div class="report-subtitle" id="reportSubtitle"></div>
          <div class="report-date" id="reportDate"></div>
        </div>

        <!-- ส่วนเนื้อหารายงาน -->
        <div class="table-container">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th width="5%">ลำดับ</th>
                <th width="15%">วันที่</th>
                <th width="25%">ชื่อสื่อ/นวัตกรรม</th>
                <th width="20%">ชื่อผู้ผลิตสื่อ</th>
                <th width="10%">จำนวน</th>
                <th width="15%">จุดประสงค์</th>
                <th width="10%">ผู้รับรอง</th>
              </tr>
            </thead>
            <tbody id="reportTableBody">
              <!-- จะเติมข้อมูลด้วย JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- ส่วนสรุปรายงาน -->
        <div class="summary-container" id="reportSummary">
          <!-- จะเติมข้อมูลด้วย JavaScript -->
        </div>
        
        <!-- สำหรับรายงานสรุปตามผู้ผลิตสื่อ -->
        <div class="container mt-4" id="summaryReportContainer" style="display: none;">
          <div class="table-container">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th width="10%">ลำดับ</th>
                  <th width="50%">ชื่อผู้ผลิตสื่อ</th>
                  <th width="20%">จำนวนรายการ</th>
                  <th width="20%">จำนวนรวม</th>
                </tr>
              </thead>
              <tbody id="summaryTableBody">
                <!-- จะเติมข้อมูลด้วย JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal แก้ไขข้อมูล -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">แก้ไขข้อมูล</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editRecordId" name="recordId">
            <div class="mb-3">
              <label for="editName" class="form-label">ชื่อสื่อ/นวัตกรรม</label>
              <input type="text" class="form-control" id="editName" name="name" required>
            </div>
            <div class="mb-3">
              <label for="editProducer" class="form-label">ชื่อผู้ผลิตสื่อ/นวัตกรรม</label>
              <input type="text" class="form-control" id="editProducer" name="producer" required>
            </div>
            <div class="mb-3">
              <label for="editAmount" class="form-label">จำนวน</label>
              <input type="number" class="form-control" id="editAmount" name="amount" min="1" required>
            </div>
            <div class="mb-3">
              <label for="editObject" class="form-label">จุดประสงค์</label>
              <input type="text" class="form-control" id="editObject" name="object" required>
            </div>
            <div class="mb-3">
              <label for="editName2" class="form-label">ผู้รับรอง</label>
              <input type="text" class="form-control" id="editName2" name="name2" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">บันทึกการแก้ไข</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal ยืนยันการลบ -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">ยืนยันการลบ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>คุณต้องการลบข้อมูลนี้ใช่หรือไม่?</p>
          <p id="deleteRecordInfo"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ยืนยันการลบ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- เพิ่ม Bootstrap และ JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ตัวแปรสำหรับเก็บข้อมูล
    let allRecords = [];
    let producers = [];
    let currentReportType = 'all';
    let selectedProducer = '';
    let deleteRecordId = null;
    
    // เมื่อโหลดหน้าเสร็จ
    document.addEventListener('DOMContentLoaded', function() {
      // โหลดข้อมูลเริ่มต้น
      loadAllData();
      
      // เพิ่ม event listener สำหรับฟอร์มเพิ่มข้อมูล
      document.getElementById('addForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addRecord();
      });
      
      // เพิ่ม event listener สำหรับปุ่มรีเฟรช
      document.getElementById('refreshBtn').addEventListener('click', function() {
        loadAllData();
      });
      
      // เพิ่ม event listener สำหรับปุ่มบันทึกการแก้ไข
      document.getElementById('saveEditBtn').addEventListener('click', function() {
        updateRecord();
      });
      
      // เพิ่ม event listener สำหรับปุ่มยืนยันการลบ
      document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        deleteRecord();
      });
      
      // ตั้งค่าวันที่รายงาน
      setReportDate();
      
      // เพิ่ม event listener สำหรับตัวเลือกประเภทรายงาน
      document.getElementById('reportType').addEventListener('change', function() {
        currentReportType = this.value;
        toggleProducerFilter();
      });
      
      // เพิ่ม event listener สำหรับปุ่มสร้างรายงาน
      document.getElementById('generateReportBtn').addEventListener('click', generateReport);
      
      // เพิ่ม event listener สำหรับปุ่มพิมพ์รายงาน
      document.getElementById('printReportBtn').addEventListener('click', function() {
        window.print();
      });
      
      // เพิ่ม event listener สำหรับแท็บรายงาน
      document.getElementById('report-tab').addEventListener('click', function() {
        loadProducers();
      });
    });
    
    // โหลดข้อมูลทั้งหมด
    function loadAllData() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            allRecords = response.records;
            displayRecordsInTable(allRecords);
          } else {
            alert('เกิดข้อผิดพลาด: ' + response.message);
          }
        })
        .getAllRecords();
    }
    
    // แสดงข้อมูลในตาราง
    function displayRecordsInTable(records) {
      const tableBody = document.getElementById('dataTableBody');
      tableBody.innerHTML = '';
      
      if (records.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 8;
        cell.textContent = 'ไม่พบข้อมูล';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }
      
      records.forEach(function(record) {
        const row = document.createElement('tr');
        
        // ลำดับ
        const noCell = document.createElement('td');
        noCell.textContent = record.No;
        row.appendChild(noCell);
        
        // วันที่
        const dateCell = document.createElement('td');
        const date = new Date(record.Date);
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        dateCell.textContent = date.toLocaleDateString('th-TH', options);
        row.appendChild(dateCell);
        
        // ชื่อสื่อ/นวัตกรรม
        const nameCell = document.createElement('td');
        nameCell.textContent = record.Name;
        row.appendChild(nameCell);
        
        // ชื่อผู้ผลิตสื่อ
        const producerCell = document.createElement('td');
        producerCell.textContent = record.Producer;
        row.appendChild(producerCell);
        
        // จำนวน
        const amountCell = document.createElement('td');
        amountCell.textContent = record.Amount;
        row.appendChild(amountCell);
        
        // จุดประสงค์
        const objectCell = document.createElement('td');
        objectCell.textContent = record.Object;
        row.appendChild(objectCell);
        
        // ผู้รับรอง
        const name2Cell = document.createElement('td');
        name2Cell.textContent = record.Name2;
        row.appendChild(name2Cell);
        
        // จัดการ
        const actionCell = document.createElement('td');
        
        // ปุ่มแก้ไข
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-warning me-1';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.title = 'แก้ไข';
        editBtn.addEventListener('click', function() {
          openEditModal(record);
        });
        actionCell.appendChild(editBtn);
        
        // ปุ่มลบ
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-danger';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        deleteBtn.title = 'ลบ';
        deleteBtn.addEventListener('click', function() {
          openDeleteModal(record);
        });
        actionCell.appendChild(deleteBtn);
        
        row.appendChild(actionCell);
        
        tableBody.appendChild(row);
      });
    }
    
    // เพิ่มข้อมูล
    function addRecord() {
      const form = document.getElementById('addForm');
      const formData = {
        name: form.elements.name.value,
        producer: form.elements.producer.value,
        amount: form.elements.amount.value,
        object: form.elements.object.value,
        name2: form.elements.name2.value,
        action: 'create'
      };
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('เพิ่มข้อมูลสำเร็จ');
            form.reset();
            loadAllData();
          } else {
            alert('เกิดข้อผิดพลาด: ' + response.message);
          }
        })
        .doPost(formData);
    }
    
    // เปิด Modal แก้ไขข้อมูล
    function openEditModal(record) {
      document.getElementById('editRecordId').value = record.No;
      document.getElementById('editName').value = record.Name;
      document.getElementById('editProducer').value = record.Producer;
      document.getElementById('editAmount').value = record.Amount;
      document.getElementById('editObject').value = record.Object;
      document.getElementById('editName2').value = record.Name2;
      
      const editModal = new bootstrap.Modal(document.getElementById('editModal'));
      editModal.show();
    }
    
    // แก้ไขข้อมูล
    function updateRecord() {
      const form = document.getElementById('editForm');
      const formData = {
        recordId: form.elements.recordId.value,
        name: form.elements.name.value,
        producer: form.elements.producer.value,
        amount: form.elements.amount.value,
        object: form.elements.object.value,
        name2: form.elements.name2.value,
        action: 'update'
      };
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('แก้ไขข้อมูลสำเร็จ');
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            editModal.hide();
            loadAllData();
          } else {
            alert('เกิดข้อผิดพลาด: ' + response.message);
          }
        })
        .doPost(formData);
    }
    
    // เปิด Modal ยืนยันการลบ
    function openDeleteModal(record) {
      deleteRecordId = record.No;
      document.getElementById('deleteRecordInfo').textContent = 'ชื่อสื่อ/นวัตกรรม: ' + record.Name;
      
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
      deleteModal.show();
    }
    
    // ลบข้อมูล
    function deleteRecord() {
      const formData = {
        recordId: deleteRecordId,
        action: 'delete'
      };
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('ลบข้อมูลสำเร็จ');
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            deleteModal.hide();
            loadAllData();
          } else {
            alert('เกิดข้อผิดพลาด: ' + response.message);
          }
        })
        .doPost(formData);
    }
    
    // ฟังก์ชันสำหรับหน้ารายงาน
    
    // ตั้งค่าวันที่รายงาน
    function setReportDate() {
      const now = new Date();
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('reportDate').textContent = 'วันที่พิมพ์: ' + now.toLocaleDateString('th-TH', options);
    }

    // โหลดรายชื่อผู้ผลิตสื่อ
    function loadProducers() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            producers = response.producers;
            populateProducerFilter();
          } else {
            alert('เกิดข้อผิดพลาด: ' + response.message);
          }
        })
        .getProducerList();
    }

    // เติมข้อมูลในตัวเลือกผู้ผลิตสื่อ
    function populateProducerFilter() {
      const select = document.getElementById('producerFilter');
      select.innerHTML = '<option value="">-- เลือกผู้ผลิตสื่อ --</option>';
      
      producers.forEach(function(producer) {
        const option = document.createElement('option');
        option.value = producer;
        option.textContent = producer;
        select.appendChild(option);
      });
    }

    // แสดง/ซ่อนตัวเลือกผู้ผลิตสื่อตามประเภทรายงาน
    function toggleProducerFilter() {
      const producerFilterContainer = document.getElementById('producerFilterContainer');
      const summaryReportContainer = document.getElementById('summaryReportContainer');
      
      if (currentReportType === 'byProducer') {
        producerFilterContainer.style.display = 'block';
        summaryReportContainer.style.display = 'none';
      } else if (currentReportType === 'summary') {
        producerFilterContainer.style.display = 'none';
        summaryReportContainer.style.display = 'block';
      } else {
        producerFilterContainer.style.display = 'none';
        summaryReportContainer.style.display = 'none';
      }
    }

    // สร้างรายงาน
    function generateReport() {
      // ตรวจสอบประเภทรายงาน
      if (currentReportType === 'all') {
        loadAllRecordsForReport();
      } else if (currentReportType === 'byProducer') {
        selectedProducer = document.getElementById('producerFilter').value;
        if (!selectedProducer) {
          alert('กรุณาเลือกผู้ผลิตสื่อ');
          return;
        }
        loadRecordsByProducer(selectedProducer);
      } else if (currentReportType === 'summary') {
        loadProducerSummary();
      }
    }

    // โหลดข้อมูลทั้งหมดสำหรับรายงาน
    function loadAllRecordsForReport() {
      document.getElementById('reportSubtitle').textContent = 'รายงานทั้งหมด';
      document.getElementById('summaryReportContainer').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displayRecordsInReport(response.records);
            displaySummary(response.records.length, calculateTotalAmount(response.records));
          } else {
            alert('เกิดข้อผิดพลาด: ' + response.message);
          }
        })
        .getAllRecords();
    }

    // โหลดข้อมูลตามผู้ผลิตสื่อ
    function loadRecordsByProducer(producer) {
      document.getElementById('reportSubtitle').textContent = 'รายงานแยกตามผู้ผลิตสื่อ: ' + producer;
      document.getElementById('summaryReportContainer').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displayRecordsInReport(response.records);
            displaySummary(response.summary.totalRecords, response.summary.totalAmount);
          } else {
            alert('เกิดข้อผิดพลาด: ' + response.message);
          }
        })
        .withUserObject(this)
        .getRecordsByProducer({producer: producer});
    }

    // โหลดข้อมูลสรุปตามผู้ผลิตสื่อ
    function loadProducerSummary() {
      document.getElementById('reportSubtitle').textContent = 'รายงานสรุปตามผู้ผลิตสื่อ';
      document.getElementById('reportTableBody').innerHTML = '';
      document.getElementById('reportSummary').innerHTML = '';
      document.getElementById('summaryReportContainer').style.display = 'block';
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displaySummaryReport(response.summary);
          } else {
            alert('เกิดข้อผิดพลาด: ' + response.message);
          }
        })
        .getProducerSummary();
    }

    // แสดงข้อมูลในตารางรายงาน
    function displayRecordsInReport(records) {
      const tableBody = document.getElementById('reportTableBody');
      tableBody.innerHTML = '';
      
      if (records.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 7;
        cell.textContent = 'ไม่พบข้อมูล';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }
      
      records.forEach(function(record, index) {
        const row = document.createElement('tr');
        
        // ลำดับ
        const noCell = document.createElement('td');
        noCell.textContent = index + 1;
        row.appendChild(noCell);
        
        // วันที่
        const dateCell = document.createElement('td');
        const date = new Date(record.Date);
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        dateCell.textContent = date.toLocaleDateString('th-TH', options);
        row.appendChild(dateCell);
        
        // ชื่อสื่อ/นวัตกรรม
        const nameCell = document.createElement('td');
        nameCell.textContent = record.Name;
        row.appendChild(nameCell);
        
        // ชื่อผู้ผลิตสื่อ
        const producerCell = document.createElement('td');
        producerCell.textContent = record.Producer;
        row.appendChild(producerCell);
        
        // จำนวน
        const amountCell = document.createElement('td');
        amountCell.textContent = record.Amount;
        amountCell.style.textAlign = 'center';
        row.appendChild(amountCell);
        
        // จุดประสงค์
        const objectCell = document.createElement('td');
        objectCell.textContent = record.Object;
        row.appendChild(objectCell);
        
        // ผู้รับรอง
        const name2Cell = document.createElement('td');
        name2Cell.textContent = record.Name2;
        row.appendChild(name2Cell);
        
        tableBody.appendChild(row);
      });
    }

    // แสดงข้อมูลสรุป
    function displaySummary(totalRecords, totalAmount) {
      const summaryContainer = document.getElementById('reportSummary');
      summaryContainer.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <p><strong>จำนวนรายการทั้งหมด:</strong> ${totalRecords} รายการ</p>
          </div>
          <div class="col-md-6">
            <p><strong>จำนวนรวมทั้งหมด:</strong> ${totalAmount} ชิ้น</p>
          </div>
        </div>
      `;
    }

    // แสดงรายงานสรุปตามผู้ผลิตสื่อ
    function displaySummaryReport(summaryData) {
      const tableBody = document.getElementById('summaryTableBody');
      tableBody.innerHTML = '';
      
      if (summaryData.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 4;
        cell.textContent = 'ไม่พบข้อมูล';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }
      
      let totalRecords = 0;
      let totalAmount = 0;
      
      summaryData.forEach(function(item, index) {
        const row = document.createElement('tr');
        
        // ลำดับ
        const noCell = document.createElement('td');
        noCell.textContent = index + 1;
        row.appendChild(noCell);
        
        // ชื่อผู้ผลิตสื่อ
        const producerCell = document.createElement('td');
        producerCell.textContent = item.producer;
        row.appendChild(producerCell);
        
        // จำนวนรายการ
        const countCell = document.createElement('td');
        countCell.textContent = item.count;
        countCell.style.textAlign = 'center';
        row.appendChild(countCell);
        
        // จำนวนรวม
        const amountCell = document.createElement('td');
        amountCell.textContent = item.totalAmount;
        amountCell.style.textAlign = 'center';
        row.appendChild(amountCell);
        
        tableBody.appendChild(row);
        
        totalRecords += item.count;
        totalAmount += item.totalAmount;
      });
      
      // เพิ่มแถวสรุปรวม
      const summaryRow = document.createElement('tr');
      summaryRow.style.fontWeight = 'bold';
      
      const summaryLabelCell = document.createElement('td');
      summaryLabelCell.colSpan = 2;
      summaryLabelCell.textContent = 'รวมทั้งหมด';
      summaryLabelCell.style.textAlign = 'right';
      summaryRow.appendChild(summaryLabelCell);
      
      const totalRecordsCell = document.createElement('td');
      totalRecordsCell.textContent = totalRecords;
      totalRecordsCell.style.textAlign = 'center';
      summaryRow.appendChild(totalRecordsCell);
      
      const totalAmountCell = document.createElement('td');
      totalAmountCell.textContent = totalAmount;
      totalAmountCell.style.textAlign = 'center';
      summaryRow.appendChild(totalAmountCell);
      
      tableBody.appendChild(summaryRow);
    }

    // คำนวณจำนวนรวม
    function calculateTotalAmount(records) {
      let total = 0;
      records.forEach(function(record) {
        total += parseInt(record.Amount) || 0;
      });
      return total;
    }
  </script>
</body>
</html>
